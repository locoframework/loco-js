!function(t,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("loco-js-model")):"function"==typeof define&&define.amd?define(["loco-js-model"],n):"object"==typeof exports?exports.Loco=n(require("loco-js-model")):t.Loco=n(t.LocoModel)}(window,(function(t){return function(t){var n={};function e(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,e),i.l=!0,i.exports}return e.m=t,e.c=n,e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:o})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,n){if(1&n&&(t=e(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(e.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var i in t)e.d(o,i,function(n){return t[n]}.bind(null,i));return o},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},e.p="",e(e.s=2)}([function(n,e){n.exports=t},function(t,n,e){window,t.exports=function(t){var n={};function e(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,e),i.l=!0,i.exports}return e.m=t,e.c=n,e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:o})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,n){if(1&n&&(t=e(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(e.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var i in t)e.d(o,i,function(n){return t[n]}.bind(null,i));return o},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},e.p="",e(e.s=0)}([function(t,n,e){"use strict";function o(t){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}e.r(n),e.d(n,"init",(function(){return c})),e.d(n,"helpers",(function(){return l})),e.d(n,"Controllers",(function(){return u}));var i=function(t){"function"==typeof t.constructor.initialize&&t.constructor.initialize(),"function"==typeof t.initialize&&t.initialize()},r=function(t,n,e){var i=void 0===e?t[n]:t[n][e];return"function"==typeof i?new i:"object"===o(i)?i:null},c=function(t){var n=document.getElementsByTagName("body")[0],e=n.getAttribute("data-namespace"),o=n.getAttribute("data-controller"),c=n.getAttribute("data-action"),l=r(t,e),u=r(t,o);return null!==l&&(u=r(t,e,o),l.controller=u,i(l)),null!==u&&(u.namespaceController=l,function(t,n){i(t),"function"==typeof t.constructor[n]&&t.constructor[n](),"function"==typeof t[n]&&t[n]()}(u,c)),{namespaceController:l,controller:u,action:c}},l={get params(){return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.location.href,n={},e=/https?:\/\/.+\/\w+\/(\d+)/.exec(t),o=null!==e?e[1]:null;null!==o&&(n.id=parseInt(o));var i=t.split("?");if(1===i.length)return n;var r=i[i.length-1],c=r.split("&").map((function(t){return t.split("=")})),l=!0,u=!1,s=void 0;try{for(var a,f=c[Symbol.iterator]();!(l=(a=f.next()).done);l=!0){var d=a.value,p=decodeURIComponent(d[0]),y=decodeURIComponent(d[1]);"string"==typeof y&&(y=y.replace(/\+/g," ")),n[p]=y}}catch(t){u=!0,s=t}finally{try{l||null==f.return||f.return()}finally{if(u)throw s}}return n}()}},u={Base:function t(){!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,t)}}}])},function(t,n,e){"use strict";e.r(n),e.d(n,"getLine",(function(){return T})),e.d(n,"getLocale",(function(){return b})),e.d(n,"setLocale",(function(){return w})),e.d(n,"getWire",(function(){return S})),e.d(n,"connector",(function(){return j})),e.d(n,"emit",(function(){return C})),e.d(n,"helpers",(function(){return i.helpers})),e.d(n,"init",(function(){return M})),e.d(n,"subscribe",(function(){return _})),e.d(n,"Controllers",(function(){return i.Controllers})),e.d(n,"Env",(function(){return o})),e.d(n,"I18n",(function(){return r.I18n})),e.d(n,"Models",(function(){return r.Models})),e.d(n,"Validators",(function(){return r.Validators}));var o={loco:null,namespaceController:null,controller:null,action:null},i=e(1),r=e(0),c=void 0;i.Controllers.Base.prototype.setScope=function(t){return r.Config.scope=t},i.Controllers.Base.prototype.setResource=function(t){return c.setScope(t)};var l={cable:null,NotificationCenter:null},u=function(){function t(){}return t.toURIParams=function(t){var n,e,o;for(n in e="",t)o=t[n],""!==e&&(e+="&"),e+=n+"="+encodeURIComponent(o);return e},t}();function s(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){if(!(Symbol.iterator in Object(t))&&"[object Arguments]"!==Object.prototype.toString.call(t))return;var e=[],o=!0,i=!1,r=void 0;try{for(var c,l=t[Symbol.iterator]();!(o=(c=l.next()).done)&&(e.push(c.value),!n||e.length!==n);o=!0);}catch(t){i=!0,r=t}finally{try{o||null==l.return||l.return()}finally{if(i)throw r}}return e}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var a=function(t,n,e,o,i){var c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;null===c&&(c=new o({id:t}));var l=!0,u=!1,s=void 0;try{for(var a,f=r.IdentityMap.findConnected(i,t)[Symbol.iterator]();!(l=(a=f.next()).done);l=!0){var d=a.value;d(n,e)}}catch(t){u=!0,s=t}finally{try{l||null==f.return||f.return()}finally{if(u)throw s}}},f=function(t,n,e){var o=!0,i=!1,c=void 0;try{for(var l,u=r.IdentityMap.imap[e].collection[Symbol.iterator]();!(o=(l=u.next()).done);o=!0){(0,l.value)("".concat(e," ").concat(t),n)}}catch(t){i=!0,c=t}finally{try{o||null==u.return||u.return()}finally{if(i)throw c}}},d=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n.log&&console.log(t);var e=s(t,4),i=e[0],c=e[1],u=e[2],d=e[3],p=o.loco.getModelForRemoteName(i),y=p.getIdentity();null!=l.NotificationCenter&&l.NotificationCenter({signal:"".concat(y," ").concat(u),payload:d}),void 0!==r.IdentityMap.imap[y]&&(void 0!==r.IdentityMap.imap[y][c]&&a(c,u,d,p,y),void 0!==r.IdentityMap.imap[y].collection&&0!==r.IdentityMap.imap[y].collection.length&&f(u,d,y))},p=function(){function t(t){var n,e,o,i;null==t&&(t={}),this.syncTime=null,this.token=null,this.pollingInterval=null,this.pollingTime=null!=(n=t.pollingTime)?n:3e3,this.log=!(null==t.log||!t.log),this.ssl=t.ssl,this.location=null!=(e=t.location)?e:"notification-center",this.size=null!=(o=t.size)?o:100,this.protocolWithHost=t.protocolWithHost,this.allowedDisconnectionTime=null!=(i=t.allowedDisconnectionTime)?i:10,this.disconnectedSinceTime=null,this.uuid=null,this.delayedDisconnection=!1}return t.prototype.resetSyncTime=function(){return this.syncTime=null},t.prototype.setPollingTime=function(t){return this.pollingTime=t,this.disconnect(),this.connect()},t.prototype.connect=function(){var t,n;if(null==(t=o.loco.line)||t.isWireAllowed())return this.pollingInterval=setInterval((n=this,function(){if(n.check(),n.delayedDisconnection)return n.delayedDisconnection=!1,n.disconnect()}),this.pollingTime)},t.prototype.disconnect=function(){return window.clearInterval(this.pollingInterval)},t.prototype.check=function(){var t,n;if(0!==Object.keys(r.IdentityMap.imap).length||null!=this.token||null==this.syncTime)return(t=new XMLHttpRequest).open("GET",this._getURL()+"?"+u.toURIParams(this._requestParams())),t.onload=(n=this,function(t){var e,o,i,r,c;if(t.target.status>=200&&t.target.status<400){if(e=JSON.parse(t.target.response),n.disconnectedSinceTime=null,n.syncTime=e[1],0===(c=e[0]).length)return;for(o=0,i=c.length;o<i;o++)r=c[o],d(r,{log:n.log});if(c.length===n.size)return n.check()}else if(t.target.status>=500)return n._handleDisconnection()}),t.onerror=function(t){return function(){return t._handleDisconnection()}}(this),t.send()},t.prototype.fetchSyncTime=function(t){var n,e;return null==t&&(t={}),(n=new XMLHttpRequest).open("GET",this._getURL()+"/sync-time"),n.onerror=(e=this,function(){if(null!=t.after)return e[t.after]()}),n.onload=function(n){return function(e){var o;if(e.target.status>=200&&e.target.status<400){if(o=JSON.parse(e.target.response),n.syncTime=o.sync_time,null!=t.after)return n[t.after]()}else if(e.target.status>=500&&null!=t.after)return n[t.after]()}}(this),n.send()},t.prototype._requestParams=function(){var t;return t={synced_at:this.syncTime},null!=this.token&&(t.token=this.token),null!=this.uuid&&(t.uuid=this.uuid),t},t.prototype._getURL=function(){var t,n,e,o;return n=(e=window.location.href.split("/"))[0],e[1],t=e[2],null!=this.protocolWithHost&&(n=(o=this.protocolWithHost.split("//"))[0],t=o[1]),null!=this.ssl&&(n=this.ssl?"https:":"http:"),n+"//"+t+"/"+this.location},t.prototype._handleDisconnection=function(){var t,n,e;if(null==this.disconnectedSinceTime&&(this.disconnectedSinceTime=new Date),n=(new Date-this.disconnectedSinceTime)/1e3,t=null!=(e=o.namespaceController)?e:o.controller,n>this.allowedDisconnectionTime&&null!=t.disconnectedForTooLong)return t.disconnectedForTooLong(this.disconnectedSinceTime)},t}(),y=[];function h(t){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var m=function(t,n){var e,o=n.line,i=n.wire,r=n.processNotification;if(!0===t.connection_check&&o.send({loco:{connection_check:!0}}),null!=i)return"string"==typeof t.sync_time&&(i.syncTime=t.sync_time),"string"==typeof t.uuid&&(console.log("uuid: ".concat(t.uuid)),i.uuid=t.uuid),"object"===h(t.notification)&&"Array"===t.notification.constructor.name&&r(t.notification,{log:i.log}),!0===t.xhr_notifications&&i.check(),!0===t.start_ajax_polling&&(console.log("wire connected"),o.connected=null,i.uuid=null,i.fetchSyncTime({after:"connect"})),"string"!=typeof t.idempotency_key||(e=t.idempotency_key,!y.includes(e)&&(y.unshift(e),y.length>100&&y.pop(),!0))},g=function(){function t(t){null==t&&(t={}),this.connected=!1,this.subscription=null}return t.prototype.connect=function(){return this.subscription=l.cable.subscriptions.create({channel:"Loco::NotificationCenterChannel"},{connected:(t=this,function(){var n;return console.log("ws connected"),t.connected=!0,null!=(n=o.loco.wire)&&(n.delayedDisconnection=!0),l.NotificationCenter({loco:"connected"})}),disconnected:function(t){return function(){var n;return console.log("ws disconnected"),t.connected=!1,null!=(n=o.loco.wire)&&(n.uuid=null,n.fetchSyncTime({after:"connect"})),l.NotificationCenter({loco:"disconnected"})}}(this),rejected:function(){return console.log("ws rejected"),l.NotificationCenter({loco:"rejected"})},received:function(t){return function(n){if(null!=n.loco){if(!m(n.loco,{line:t,wire:o.loco.wire,processNotification:d}))return;delete n.loco}if(0!==Object.keys(n).length)return l.NotificationCenter(n)}}(this)});var t},t.prototype.isWireAllowed=function(){return!this.connected},t.prototype.send=function(t){return this.subscription.send(t)},t}(),v=function(){function t(t){var n,e,o;null==t&&(t={}),this.wire=null,this.line=null,this.startWire=!!(null!=(e=t.notifications)?e.enable:void 0),this.postInit=t.postInit,(n=null!=(o=t.notifications)?o:{}).protocolWithHost=t.protocolWithHost,this.notificationsParams=n}return t.prototype.init=function(t){return o.loco=this,this.initWire(),this.initLine(t.cable),this.ready((n=this,function(){var t;if(r.IdentityMap.clear(),t=Object(i.init)(i.Controllers),o.namespaceController=t.namespaceController,o.controller=t.controller,o.action=t.action,null!=n.wire&&(n.wire.resetSyncTime(),n.wire.fetchSyncTime()),null!=n.postInit)return n.postInit()}));var n},t.prototype.ready=function(t){return(document.attachEvent?"complete"===document.readyState:"loading"!==document.readyState)?t():document.addEventListener("DOMContentLoaded",t)},t.prototype.initWire=function(){if(this.startWire)return this.wire=new p(this.notificationsParams),this.wire.fetchSyncTime({after:"connect"})},t.prototype.initLine=function(t){if(null!=t)return this.line=new g,this.line.connect()},t.prototype.emit=function(t){return this.line.send(t)},t.prototype.getModels=function(){var t,n,e,o,i;for(t in e=[],i=/^[A-Z]/,r.Models)if(r.Models[t],i.exec(t)&&"Base"!==t)for(n in e.push(t),o=r.Models[t])o[n],i.exec(n)&&e.push(t+"."+n);return e},t.prototype.getModelForRemoteName=function(t){var n,e,o,i;for(n=0,e=(i=this.getModels()).length;n<e;n++)if(1===(o=i[n].split(".")).length){if(r.Models[o[0]].getRemoteName()===t)return r.Models[o[0]]}else if(2===o.length&&r.Models[o[0]][o[1]].getRemoteName()===t)return r.Models[o[0]][o[1]]},t}(),b=function(){return r.Config.locale},w=function(t){return r.Config.locale=t},S=function(){return o.loco.wire},T=function(){return o.loco.line.subscription},C=function(t){return o.loco.emit(t)},M=function(t){r.Config.locale=t.locale||"en",r.Config.protocolWithHost=t.protocolWithHost,l.cable=t.cable,l.NotificationCenter=t.notificationCenter,new v(t).init({cable:l.cable,protocolWithHost:r.Config.protocolWithHost})},j={getLocale:b,Env:o,I18n:r.I18n},_=r.IdentityMap.subscribe}])}));