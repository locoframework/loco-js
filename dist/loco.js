!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("loco-js-model")):"function"==typeof define&&define.amd?define(["loco-js-model"],e):"object"==typeof exports?exports.Loco=e(require("loco-js-model")):t.Loco=e(t.LocoModel)}(self,(t=>(()=>{"use strict";var e={904:e=>{e.exports=t}},n={};function o(t){var i=n[t];if(void 0!==i)return i.exports;var r=n[t]={exports:{}};return e[t](r,r.exports,o),r.exports}o.d=(t,e)=>{for(var n in e)o.o(e,n)&&!o.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var i={};return(()=>{o.r(i),o.d(i,{Models:()=>t.Models,init:()=>T,subscribe:()=>C});var t=o(904);const e=function(){function t(){}return t.toURIParams=function(t){var e,n,o;for(e in n="",t)o=t[e],""!==n&&(n+="&"),n+=e+"="+encodeURIComponent(o);return n},t}(),n=function(t,e,n){var o=document.querySelector("meta[name='csrf-token']"),i=new XMLHttpRequest;return i.withCredentials=!0===n.cookiesByCORS,i.open(t,e),i.setRequestHeader("Accept","application/json"),o&&i.setRequestHeader("X-CSRF-Token",o.content),null!=n.authorizationHeader&&i.setRequestHeader("Authorization",n.authorizationHeader),i};var r=[];const c=function(t){return!!r.includes(t)||(r.unshift(t),r.length>100&&r.pop(),!1)};var l;l=function(){var e,n,o,i,r;for(e in o=[],r=/^[A-Z]/,t.Models)if(t.Models[e],r.exec(e)&&"Base"!==e)for(n in o.push(e),i=t.Models[e])i[n],r.exec(n)&&o.push(e+"."+n);return o};function s(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=u(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var o=0,i=function(){};return{s:i,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,c=!0,l=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return c=t.done,t},e:function(t){l=!0,r=t},f:function(){try{c||null==n.return||n.return()}finally{if(l)throw r}}}}function u(t,e){if(t){if("string"==typeof t)return a(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?a(t,e):void 0}}function a(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}var f=function(t,e,n,o){null!=t&&t({type:e,payload:n},o)};const d=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n.log&&console.log(e);var o,i,r=(i=4,function(t){if(Array.isArray(t))return t}(o=e)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var o,i,r,c,l=[],s=!0,u=!1;try{if(r=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;s=!1}else for(;!(s=(o=r.call(n)).done)&&(l.push(o.value),l.length!==e);s=!0);}catch(t){u=!0,i=t}finally{try{if(!s&&null!=n.return&&(c=n.return(),Object(c)!==c))return}finally{if(u)throw i}}return l}}(o,i)||u(o,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),a=r[0],d=r[1],p=r[2],h=r[3];if(c(h.loco.idempotency_key))return!1;delete h.loco;var y=function(e){var n,o,i,r;for(n=0,o=(r=l()).length;n<o;n++)if(1===(i=r[n].split(".")).length){if(t.Models[i[0]].getRemoteName()===e)return t.Models[i[0]]}else if(2===i.length&&t.Models[i[0]][i[1]].getRemoteName()===e)return t.Models[i[0]][i[1]]}(a);if(void 0===y)return f(n.notificationCenter,"".concat(a," ").concat(p),h,n.emit),!1;var m=y.getIdentity();return f(n.notificationCenter,"".concat(m," ").concat(p),h,n.emit),void 0!==t.IdentityMap.imap[m]&&(void 0!==t.IdentityMap.imap[m][d]&&function(e,n,o,i,r){var c=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;null===c&&(c=new i({id:e}));var l,u=s(t.IdentityMap.findConnected(r,e));try{for(u.s();!(l=u.n()).done;)(0,l.value)(n,o)}catch(t){u.e(t)}finally{u.f()}}(d,p,h,y,m),void 0!==t.IdentityMap.imap[m].collection&&0!==t.IdentityMap.imap[m].collection.length&&(function(e,n,o){var i,r=s(t.IdentityMap.imap[o].collection);try{for(r.s();!(i=r.n()).done;)(0,i.value)("".concat(o," ").concat(e),n)}catch(t){r.e(t)}finally{r.f()}}(p,h,m),!0))};var p;p=function(){function t(t,e,n){var o,i,r,c;this.pollingTime=null!=(o=t.pollingTime)?o:3e3,this.log=!(null==t.log||!t.log),this.ssl=t.ssl,this.location=null!=(i=t.location)?i:"notification-center",this.size=null!=(r=t.size)?r:100,this.protocolWithHost=t.protocolWithHost,this.allowedDisconnectionTime=null!=(c=t.allowedDisconnectionTime)?c:10,this.disconnectedForTooLong=t.disconnectedForTooLong,this.notificationCenter=e,this.reqOpts=n,this.syncTime=null,this.token=null,this.pollingInterval=null,this.disconnectedSinceTime=null,this.uuid=null,this.line=null}return t.prototype.setDisconnectedForTooLong=function(t){return this.disconnectedForTooLong=t},t.prototype.setLine=function(t){return this.line=t},t.prototype.setPollingTime=function(t){var e;if(this.pollingTime=t,!(null!=(e=this.line)?e.connected:void 0))return this.disconnect(),this.connect()},t.prototype.connect=function(){return this.check(),this.pollingInterval=setInterval((t=this,function(){var e;if(!(null!=(e=t.line)?e.connected:void 0))return t.check();t.disconnect()}),this.pollingTime);var t},t.prototype.disconnect=function(){return window.clearInterval(this.pollingInterval)},t.prototype.check=function(){var t,o;return(t=n("GET",this._getURL()+"?"+e.toURIParams(this._requestParams()),this.reqOpts)).onload=(o=this,function(t){var e,n,i,r,c;if(t.target.status>=200&&t.target.status<400){if(e=JSON.parse(t.target.response),o.disconnectedSinceTime=null,o.syncTime=e[1],0===(c=e[0]).length)return;for(n=0,i=c.length;n<i;n++)r=c[n],d(r,{log:o.log,notificationCenter:o.notificationCenter,emit:o.line.send});if(c.length===o.size)return o.check()}else if(t.target.status>=500)return o._handleDisconnection()}),t.onerror=function(t){return function(){return t._handleDisconnection()}}(this),t.send()},t.prototype.fetchSyncTime=function(t){var e,o;return null==t&&(t={}),(e=n("GET",this._getURL()+"/sync-time",this.reqOpts)).onerror=(o=this,function(){if(null!=t.after)return o[t.after]()}),e.onload=function(e){return function(n){var o;if(n.target.status>=200&&n.target.status<400){if(o=JSON.parse(n.target.response),e.syncTime=o.sync_time,null!=t.after)return e[t.after]()}else if(n.target.status>=500&&null!=t.after)return e[t.after]()}}(this),e.send()},t.prototype._requestParams=function(){var t;return t={synced_at:this.syncTime},null!=this.token&&(t.token=this.token),null!=this.uuid&&(t.uuid=this.uuid),t},t.prototype._getURL=function(){var t,e,n,o;return e=(n=window.location.href.split("/"))[0],n[1],t=n[2],null!=this.protocolWithHost&&(e=(o=this.protocolWithHost.split("//"))[0],t=o[1]),null!=this.ssl&&(e=this.ssl?"https:":"http:"),e+"//"+t+"/"+this.location},t.prototype._handleDisconnection=function(){if(null==this.disconnectedSinceTime&&(this.disconnectedSinceTime=new Date),(new Date-this.disconnectedSinceTime)/1e3>this.allowedDisconnectionTime&&null!=this.disconnectedForTooLong)return this.disconnectedForTooLong(this.disconnectedSinceTime)},t}();const h=p;function y(t){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},y(t)}function m(t){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},m(t)}function v(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,g(o.key),o)}}function g(t){var e=function(t,e){if("object"!=m(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,"string");if("object"!=m(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==m(e)?e:String(e)}var b=function(){function t(e,n,o){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.cable=e,this.notificationCenter=n,this.wire=o,this.connected=!1,this.subscription=null}var e,n;return e=t,n=[{key:"connect",value:function(){var t=this;this.subscription=this.cable.subscriptions.create({channel:"Loco::NotificationCenterChannel"},{connected:function(){console.log("WS connected"),t.connected=!0,t.notificationCenter({loco:"connected"}),t.pong()},disconnected:function(){console.log("WS disconnected"),t.connected=!1,null!==t.wire&&(t.wire.uuid=null,t.wire.fetchSyncTime({after:"connect"})),t.notificationCenter({loco:"disconnected"})},rejected:function(){console.log("WS rejected"),t.notificationCenter({loco:"rejected"})},received:function(e){if(null!=e.loco){if(!0!==function(t,e){var n=e.line,o=e.wire,i=e.processNotification,r=e.notificationCenter;if(!0===t.ping&&n.pong(),null!=o)return"string"==typeof t.sync_time&&(o.syncTime=t.sync_time),"string"==typeof t.uuid&&(console.log("uuid: ".concat(t.uuid)),o.uuid=t.uuid),"object"===y(t.notification)&&"Array"===t.notification.constructor.name&&i(t.notification,{log:o.log,notificationCenter:r,emit:(void 0).line.send}),"string"!=typeof t.idempotency_key||!c(t.idempotency_key)}(e.loco,{line:t,wire:t.wire,processNotification:d,notificationCenter:t.notificationCenter}))return;delete e.loco}0!==Object.keys(e).length&&t.notificationCenter(e)}})}},{key:"send",value:function(t){this.subscription.send(t)}},{key:"pong",value:function(){var t=this;setTimeout((function(){return t.send({loco:{pong:!0}})}),3e3)}}],n&&v(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();const S=b,w=function(){function e(t){this.models=t,this.wire=null,this.line=null}return e.prototype.getModels=function(){return this.models},e.prototype.getLine=function(){var t;return null!=(t=this.line)?t.subscription:void 0},e.prototype.getWire=function(){return this.wire},e.prototype.setAuthorizationHeader=function(t){var e,n,o,i;for(e in i=[],o=this.models)n=o[e],i.push(n.authorizationHeader=t);return i},e.prototype.setDisconnectedForTooLong=function(t){return this.wire.setDisconnectedForTooLong(t)},e.prototype.init=function(e){var n,o,i;return(n=null!=(o=e.notifications)?o:{}).protocolWithHost=e.protocolWithHost,!1!==n.enable&&(i={cookiesByCORS:e.cookiesByCORS,authorizationHeader:e.authorizationHeader},this.wire=new h(n,e.notificationCenter,i),this.wire.fetchSyncTime({after:"connect"})),null!=e.cable&&(this.line=new S(e.cable,e.notificationCenter,this.wire),this.line.connect()),null!=this.wire&&this.wire.setLine(this.line),this._ready((function(){if(t.IdentityMap.clear(),null!=e.postInit)return e.postInit()}))},e.prototype.emit=function(t){return this.line.send(t)},e.prototype._ready=function(t){return(document.attachEvent?"complete"===document.readyState:"loading"!==document.readyState)?t():document.addEventListener("DOMContentLoaded",t)},e}();var T=function(e){var n=function(e){for(var n=e.models||{},o=0,i=Object.keys(n);o<i.length;o++){var r=i[o];t.Models[r]=n[r]}return n}(e),o=new w(n);return o.init(e),o},C=t.IdentityMap.subscribe})(),i})()));
//# sourceMappingURL=loco.js.map